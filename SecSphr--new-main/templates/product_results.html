{% extends "base.html" %}

{% block title %}Security Assessment Results - SecureSphere{% endblock %}

{% block content %}
<div class="dashboard-header text-center mb-4">
    <h1 class="display-6 fw-bold mb-2">
        <i class="bi bi-shield-check me-3"></i>Security Assessment Results
    </h1>
    <p class="lead mb-0">Comprehensive analysis of your security posture by dimension</p>
</div>

<!-- Key Metrics Dashboard -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card maturity-score-card">
            <div class="metric-icon">
                <i class="bi bi-award-fill"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ maturity_score }}/5</h3>
                <p class="metric-label">MATURITY SCORE</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-check2-circle"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ responses|length }}</h3>
                <p class="metric-label">Total Responses</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-layers"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ dimension_scores|length }}</h3>
                <p class="metric-label">Security Dimensions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ "%.1f"|format((dimension_scores.values()|map(attribute='average_score')|sum / dimension_scores|length) if dimension_scores else 0) }}</h3>
                <p class="metric-label">Average Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Maturity Level Heatmap -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Security Maturity Heatmap
                        </h5>
                        <small class="text-muted">Visual representation of your security maturity across all dimensions</small>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportHeatmapData()" title="Export heatmap data">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Overall Maturity Level Display -->
                <div class="maturity-level-display mb-4">
                    <div class="text-center">
                        <h4 class="mb-2">Overall Maturity Level</h4>
                        <div class="maturity-badge-large level-{{ maturity_score }}">
                            <div class="level-number">{{ maturity_score }}</div>
                            <div class="level-text">
                                {% if maturity_score == 1 %}
                                    Initial
                                {% elif maturity_score == 2 %}
                                    Developing
                                {% elif maturity_score == 3 %}
                                    Defined
                                {% elif maturity_score == 4 %}
                                    Managed
                                {% elif maturity_score == 5 %}
                                    Optimized
                                {% else %}
                                    Not Assessed
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-muted mt-2">
                            {% if maturity_score == 1 %}
                                Basic security measures in place with ad-hoc processes
                            {% elif maturity_score == 2 %}
                                Some security processes defined but inconsistently applied
                            {% elif maturity_score == 3 %}
                                Well-defined security processes documented and followed
                            {% elif maturity_score == 4 %}
                                Security processes are measured and controlled
                            {% elif maturity_score == 5 %}
                                Continuous improvement with optimized security processes
                            {% else %}
                                Complete your assessment to see your maturity level
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Section-wise Performance -->
                {% if section_dimensions %}
                <div class="section-performance mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="bi bi-bar-chart me-2"></i>Section-wise Performance Breakdown
                    </h6>
                    <div class="row">
                        {% for section, data in section_dimensions.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="section-card">
                                <div class="section-header">
                                    <h6 class="section-title">{{ section }}</h6>
                                    <span class="section-percentage">{{ data.percentage }}%</span>
                                </div>
                                <div class="section-progress mb-2">
                                    <div class="progress">
                                        <div class="progress-bar bg-info" 
                                             style="width: {{ data.percentage }}%"></div>
                                    </div>
                                </div>
                                <div class="section-details">
                                    <small class="text-muted">
                                        {{ data.question_count }} questions • 
                                        {{ data.total_score }}/{{ data.max_possible_score }} points
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Heatmap Grid -->
                {% if dimension_scores %}
                <div class="heatmap-container">
                    <div class="row">
                        {% for dimension, score_data in dimension_scores.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="heatmap-cell level-{{ score_data.average_score|round|int }}">
                                <div class="cell-header">
                                    <h6 class="dimension-title">{{ dimension }}</h6>
                                    <span class="maturity-level">Level {{ score_data.average_score|round|int }}</span>
                                </div>
                                <div class="cell-body">
                                    <div class="score-display">{{ score_data.average_score }}/5</div>
                                    <div class="questions-count">{{ score_data.question_count }} questions</div>
                                </div>
                                <div class="cell-progress">
                                    <div class="progress">
                                        <div class="progress-bar level-{{ score_data.average_score|round|int }}-bg" 
                                             style="width: {{ (score_data.average_score / 5 * 100)|round }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Maturity Legend -->
                <div class="maturity-legend mt-4">
                    <h6 class="mb-3">Maturity Levels</h6>
                    <div class="row">
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-1">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 1 - Initial</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-2">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 2 - Developing</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-3">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 3 - Defined</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-4">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 4 - Managed</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-5">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 5 - Optimized</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Dimension Scores Overview -->
{% if dimension_scores %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Dimension-wise Scores
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for dimension, score_data in dimension_scores.items() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="dimension-score-card">
                            <div class="dimension-name">{{ dimension }}</div>
                            <div class="dimension-score">{{ score_data.average_score }}/5</div>
                            <div class="dimension-details">
                                <small class="text-muted">
                                    {{ score_data.question_count }} questions • 
                                    Total: {{ score_data.total_score }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Security Dimensions Results -->
<div class="results-container">
    {% if responses %}
        {% set sections = {} %}
        {% for resp in responses %}
            {% if resp.section not in sections %}
                {% set _ = sections.update({resp.section: []}) %}
            {% endif %}
            {% set _ = sections[resp.section].append(resp) %}
        {% endfor %}

        <!-- Section Navigation -->
        <div class="section-navigation mb-4">
            <nav class="nav nav-pills nav-fill">
                {% for section_name in sections.keys() %}
                    <button class="nav-link {% if loop.first %}active{% endif %}"
                            data-bs-toggle="pill"
                            data-bs-target="#section-{{ loop.index0 }}"
                            type="button">
                        <i class="bi bi-shield-shaded me-2"></i>
                        {{ section_name }}
                        <span class="badge bg-light text-dark ms-2">{{ sections[section_name]|length }}</span>
                    </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Section Content -->
        <div class="tab-content" id="sectionsContent">
            {% for section_name, section_responses in sections.items() %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="section-{{ loop.index0 }}">

                    <!-- Section Header -->
                    <div class="section-header-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1">
                                    <i class="bi bi-shield-fill text-primary me-2"></i>
                                    {{ section_name }}
                                </h4>
                                <p class="text-muted mb-0">{{ section_responses|length }} questions assessed</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="section-score">
                                    <span class="score-value" data-section="{{ section_name }}">-</span>
                                    <span class="score-label">Section Score</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Grid -->
                    <div class="questions-grid">
                        {% for resp in section_responses %}
                            {% set lead_comment = resp.lead_comments|first %}
                            <div class="question-card {% if lead_comment %}status-{{ lead_comment.status }}{% else %}status-pending{% endif %}">
                                <div class="question-header">
                                    <div class="question-number">
                                        <span class="number">{{ loop.index }}</span>
                                    </div>
                                    <div class="question-status">
                                        {% if lead_comment %}
                                            {% if lead_comment.status == 'approved' %}
                                                <span class="status-indicator approved">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </span>
                                            {% elif lead_comment.status == 'needs_revision' %}
                                                <span class="status-indicator revision">
                                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                                </span>
                                            {% elif lead_comment.status == 'rejected' %}
                                                <span class="status-indicator rejected">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                </span>
                                            {% else %}
                                                <span class="status-indicator pending">
                                                    <i class="bi bi-clock-fill"></i>
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-indicator pending">
                                                <i class="bi bi-clock-fill"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="question-content">
                                    <h6 class="question-text">{{ resp.question }}</h6>

                                    <div class="answer-section">
                                        <div class="answer-label">Your Answer:</div>
                                        <div class="answer-value">{{ resp.answer }}</div>
                                    </div>

                                    {% if resp.client_comment %}
                                        <div class="comment-section">
                                            <div class="comment-label">
                                                <i class="bi bi-chat-text me-1"></i>Your Comment:
                                            </div>
                                            <div class="comment-value">{{ resp.client_comment }}</div>
                                        </div>
                                    {% endif %}

                                    {% if resp.evidence_path %}
                                        <div class="evidence-section">
                                            <div class="evidence-label">
                                                <i class="bi bi-paperclip me-1"></i>Evidence:
                                            </div>
                                            <a href="/{{ resp.evidence_path }}" target="_blank"
                                               class="evidence-link">
                                                <i class="bi bi-file-earmark"></i>
                                                View Attachment
                                            </a>
                                        </div>
                                    {% endif %}

                                    {% if lead_comment and lead_comment.comment %}
                                        <div class="reviewer-feedback">
                                            <div class="feedback-label">
                                                <i class="bi bi-person-badge me-1"></i>Reviewer Feedback:
                                            </div>
                                            <div class="feedback-content">{{ lead_comment.comment }}</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-results">
            <div class="text-center py-5">
                <i class="bi bi-clipboard-data display-1 text-muted mb-3"></i>
                <h5 class="text-muted">No Assessment Data</h5>
                <p class="text-muted">Complete your security questionnaire to view results here.</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Calculate and display scores
document.addEventListener('DOMContentLoaded', function() {
    const responses = {{ responses_json | tojson }};
    const sections = {};

    // Group responses by section
    responses.forEach(resp => {
        if (!sections[resp.section]) {
            sections[resp.section] = [];
        }
        sections[resp.section].push(resp);
    });

    // Calculate section scores
    let totalScore = 0;
    let totalQuestions = 0;
    const sectionCount = Object.keys(sections).length;

    Object.keys(sections).forEach(sectionName => {
        const sectionResponses = sections[sectionName];
        const sectionScore = calculateSectionScore(sectionResponses);

        // Update section score display
        const scoreElement = document.querySelector(`[data-section="${sectionName}"]`);
        if (scoreElement) {
            scoreElement.textContent = sectionScore + '%';
        }

        totalScore += sectionScore;
        totalQuestions += sectionResponses.length;
    });

    // Update overall metrics
    const overallScore = sectionCount > 0 ? Math.round(totalScore / sectionCount) : 0;
    document.getElementById('overallScore').textContent = overallScore + '%';
    document.getElementById('sectionsCount').textContent = sectionCount;
    document.getElementById('completionRate').textContent =
        totalQuestions > 0 ? Math.round((responses.length / totalQuestions) * 100) + '%' : '0%';
});

function calculateSectionScore(responses) {
    if (responses.length === 0) return 0;

    let approvedCount = 0;
    responses.forEach(resp => {
        // Check if response has approved status
        if (resp.lead_comments && resp.lead_comments.length > 0) {
            if (resp.lead_comments[0].status === 'approved') {
                approvedCount++;
            }
        }
    });

    return Math.round((approvedCount / responses.length) * 100);
}

// Initialize tooltips for heatmap cells
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips to heatmap cells
    const heatmapCells = document.querySelectorAll('.heatmap-cell');
    heatmapCells.forEach(cell => {
        const dimensionTitle = cell.querySelector('.dimension-title').textContent;
        const scoreDisplay = cell.querySelector('.score-display').textContent;
        const questionsCount = cell.querySelector('.questions-count').textContent;
        const level = cell.classList.toString().match(/level-(\d)/)?.[1] || '0';
        
        const levelNames = {
            '1': 'Initial - Basic security measures with ad-hoc processes',
            '2': 'Developing - Some processes defined but inconsistently applied',
            '3': 'Defined - Well-defined processes documented and followed',
            '4': 'Managed - Processes are measured and controlled',
            '5': 'Optimized - Continuous improvement with optimized processes'
        };
        
        const tooltipText = `${dimensionTitle}\nScore: ${scoreDisplay}\n${questionsCount}\nLevel: ${levelNames[level] || 'Not assessed'}`;
        
        cell.setAttribute('title', tooltipText);
        cell.setAttribute('data-bs-toggle', 'tooltip');
        cell.setAttribute('data-bs-placement', 'top');
    });
    
    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Add click animation to maturity badge
    const maturityBadge = document.querySelector('.maturity-badge-large');
    if (maturityBadge) {
        maturityBadge.addEventListener('click', function() {
            this.style.transform = 'scale(1.1)';
            setTimeout(() => {
                this.style.transform = '';
            }, 200);
        });
    }
});

// Function to export heatmap data (if needed for reports)
function exportHeatmapData() {
    {% if maturity_score and dimension_scores %}
    const heatmapData = {
        product: '{{ product.name|escape }}',
        overallMaturityScore: {{ maturity_score }},
        dimensions: [
            {% for dimension, score_data in dimension_scores.items() %}
            {
                name: '{{ dimension|escape }}',
                score: {{ score_data.average_score }},
                level: {{ score_data.average_score|round|int }},
                questionCount: {{ score_data.question_count }},
                totalScore: {{ score_data.total_score }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Download as JSON
    const dataStr = JSON.stringify(heatmapData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${heatmapData.product}_maturity_heatmap.json`;
    link.click();
    URL.revokeObjectURL(url);
    {% endif %}
}
</script>
{% endblock %}