{% extends "base.html" %}

{% block title %}Security Assessment Results - SecureSphere{% endblock %}

{% block content %}
<div class="dashboard-header text-center mb-4">
    <h1 class="display-6 fw-bold mb-2">
        <i class="bi bi-shield-check me-3"></i>Security Assessment Results
    </h1>
    <p class="lead mb-0">Comprehensive analysis of your security posture by dimension</p>
</div>

<!-- Product Selection -->
{% if user_products and user_products|length > 1 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-box-seam me-2"></i>Select Product to View
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for product in user_products %}
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="product-selection-card {% if product.id == current_product.id %}active{% endif %}">
                            <a href="{{ url_for('product_results', product_id=product.id) }}" class="text-decoration-none">
                                <div class="product-card-body">
                                    <h6 class="product-name">{{ product.name }}</h6>
                                    <div class="product-stats">
                                        {% if product.maturity_score > 0 and product.status == 'completed' %}
                                            <span class="maturity-badge level-{{ product.maturity_score }}">
                                                Level {{ product.maturity_score }}
                                            </span>
                                        {% else %}
                                            <span class="progress-badge">
                                                {{ product.completed_sections }}/{{ product.total_sections }} sections
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="product-status">
                                        <small class="text-muted">{{ product.status_display }}</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Key Metrics Dashboard -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card maturity-score-card">
            <div class="metric-icon">
                <i class="bi bi-award-fill"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ maturity_score }}/5</h3>
                <p class="metric-label">MATURITY SCORE</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-check2-circle"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ responses|length }}</h3>
                <p class="metric-label">Total Responses</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-layers"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ dimension_scores|length }}</h3>
                <p class="metric-label">Security Dimensions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ "%.1f"|format(average_dimension_score) }}</h3>
                <p class="metric-label">Average Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Security Maturity Heatmap -->
{% if dimension_scores %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>Security Maturity Heatmap
                    </h5>
                    <small class="text-muted">Visual representation of your security maturity across all dimensions</small>
                </div>
                <div class="heatmap-legend">
                    <span class="legend-item level-1">Level 1</span>
                    <span class="legend-item level-2">Level 2</span>
                    <span class="legend-item level-3">Level 3</span>
                    <span class="legend-item level-4">Level 4</span>
                    <span class="legend-item level-5">Level 5</span>
                </div>
            </div>
            <div class="card-body">
                <div class="results-heatmap-container">
                    <!-- Main Heatmap Grid -->
                    <div class="results-heatmap-grid">
                        <div class="heatmap-header">
                            <div class="header-cell dimension-header">Dimension</div>
                            <div class="header-cell score-header">Current Level</div>
                            <div class="header-cell questions-header">Questions Answered</div>
                            <div class="header-cell percentage-header">Completion %</div>
                            <div class="header-cell recommendation-header">Next Steps</div>
                        </div>
                        
                        {% for dimension, score_data in dimension_scores.items() %}
                        <div class="heatmap-row" data-dimension="{{ dimension }}">
                            <div class="dimension-cell">
                                <div class="dimension-name">{{ dimension }}</div>
                                <div class="dimension-icon">
                                    {% if dimension == 'Build and Deployment' %}
                                        <i class="bi bi-tools"></i>
                                    {% elif dimension == 'Culture and Organization' %}
                                        <i class="bi bi-people"></i>
                                    {% elif dimension == 'Implementation' %}
                                        <i class="bi bi-code-slash"></i>
                                    {% elif dimension == 'Information Gathering' %}
                                        <i class="bi bi-search"></i>
                                    {% elif dimension == 'Test and Verification' %}
                                        <i class="bi bi-check-circle"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="score-cell">
                                <div class="maturity-level level-{{ score_data.maturity_level or 1 }}">
                                    <span class="level-number">{{ score_data.maturity_level or 1 }}</span>
                                    <span class="level-text">Level {{ score_data.maturity_level or 1 }}</span>
                                </div>
                            </div>
                            
                            <div class="questions-cell">
                                <div class="questions-progress">
                                    <div class="progress-circle">
                                        <div class="progress-text">
                                            {{ score_data.answered_questions or 0 }}/{{ score_data.total_questions or 0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="percentage-cell">
                                <div class="percentage-bar">
                                    <div class="percentage-fill" 
                                         style="width: {{ score_data.percentage or 0 }}%"
                                         data-percentage="{{ score_data.percentage or 0 }}">
                                    </div>
                                    <span class="percentage-text">{{ "%.1f"|format(score_data.percentage or 0) }}%</span>
                                </div>
                            </div>
                            
                            <div class="recommendation-cell">
                                <div class="next-steps">
                                    {% set current_level = score_data.maturity_level or 1 %}
                                    {% if current_level < 5 %}
                                        <span class="next-level-badge level-{{ current_level + 1 }}">
                                            Target: Level {{ current_level + 1 }}
                                        </span>
                                        <small class="improvement-text">
                                            {% if current_level == 1 %}
                                                Focus on establishing basic processes
                                            {% elif current_level == 2 %}
                                                Implement systematic approaches
                                            {% elif current_level == 3 %}
                                                Enhance with automation and metrics
                                            {% elif current_level == 4 %}
                                                Optimize and continuously improve
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        <span class="optimized-badge">
                                            <i class="bi bi-check-circle me-1"></i>Optimized
                                        </span>
                                        <small class="improvement-text">Maintain excellence</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Heatmap Summary -->
                    <div class="heatmap-summary mt-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <div class="summary-icon">
                                        <i class="bi bi-trophy"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h6>Strongest Dimension</h6>
                                        {% set max_dimension = dimension_scores|dictsort(attribute='1.maturity_level')|reverse|first %}
                                        <p>{{ max_dimension[0] }} (Level {{ max_dimension[1].maturity_level or 1 }})</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <div class="summary-icon">
                                        <i class="bi bi-target"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h6>Focus Area</h6>
                                        {% set min_dimension = dimension_scores|dictsort(attribute='1.maturity_level')|first %}
                                        <p>{{ min_dimension[0] }} (Level {{ min_dimension[1].maturity_level or 1 }})</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <div class="summary-icon">
                                        <i class="bi bi-graph-up-arrow"></i>
                                    </div>
                                    <div class="summary-content">
                                        <h6>Improvement Potential</h6>
                                        {% set improvement_levels = 5 * dimension_scores|length - (dimension_scores.values()|sum(attribute='maturity_level') or dimension_scores|length) %}
                                        <p>{{ improvement_levels }} levels to optimize</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed Dimension Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>Detailed Dimension Analysis
                </h5>
                <small class="text-muted">Comprehensive breakdown of each security dimension</small>
            </div>
            <div class="card-body">
                <div class="dimension-analysis">
                    {% for dimension, score_data in dimension_scores.items() %}
                    <div class="dimension-section mb-4">
                        <div class="dimension-header-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="dimension-title">
                                    {% if dimension == 'Build and Deployment' %}
                                        <i class="bi bi-tools me-2"></i>
                                    {% elif dimension == 'Culture and Organization' %}
                                        <i class="bi bi-people me-2"></i>
                                    {% elif dimension == 'Implementation' %}
                                        <i class="bi bi-code-slash me-2"></i>
                                    {% elif dimension == 'Information Gathering' %}
                                        <i class="bi bi-search me-2"></i>
                                    {% elif dimension == 'Test and Verification' %}
                                        <i class="bi bi-check-circle me-2"></i>
                                    {% endif %}
                                    {{ dimension }}
                                </h6>
                                <div class="dimension-score-badge level-{{ score_data.maturity_level or 1 }}">
                                    Level {{ score_data.maturity_level or 1 }}
                                </div>
                            </div>
                            
                            <div class="dimension-progress mb-3">
                                <div class="progress progress-dimension">
                                    <div class="progress-bar level-{{ score_data.maturity_level or 1 }}" 
                                         style="width: {{ (score_data.maturity_level or 1) * 20 }}%"
                                         aria-valuenow="{{ (score_data.maturity_level or 1) * 20 }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="progress-labels">
                                    <span>Level 1</span>
                                    <span>Level 2</span>
                                    <span>Level 3</span>
                                    <span>Level 4</span>
                                    <span>Level 5</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Questions in this dimension -->
                        <div class="dimension-questions">
                            <div class="questions-grid">
                                {% set dimension_responses = responses|selectattr('section', 'equalto', dimension)|list %}
                                {% for response in dimension_responses %}
                                <div class="question-card">
                                    <div class="question-header">
                                        <div class="question-number">Q{{ loop.index }}</div>
                                        <div class="question-status">
                                            {% if response.answer %}
                                                <span class="status-answered">
                                                    <i class="bi bi-check-circle"></i>
                                                </span>
                                            {% else %}
                                                <span class="status-unanswered">
                                                    <i class="bi bi-circle"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="question-content">
                                        <p class="question-text">{{ response.question }}</p>
                                        {% if response.answer %}
                                            <div class="answer-section">
                                                <strong>Answer:</strong>
                                                <span class="answer-badge answer-{{ response.answer.lower() }}">
                                                    {{ response.answer }}
                                                </span>
                                                {% if response.client_comment %}
                                                    <div class="comment-section mt-2">
                                                        <small class="text-muted">
                                                            <i class="bi bi-chat-text me-1"></i>
                                                            {{ response.client_comment }}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Items and Recommendations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check me-2"></i>Recommended Action Items
                </h5>
                <small class="text-muted">Prioritized recommendations to improve your security posture</small>
            </div>
            <div class="card-body">
                <div class="action-items">
                    {% for dimension, score_data in dimension_scores.items() %}
                        {% set current_level = score_data.maturity_level or 1 %}
                        {% if current_level < 5 %}
                        <div class="action-item priority-{{ 6 - current_level }}">
                            <div class="action-icon">
                                <i class="bi bi-arrow-up-circle"></i>
                            </div>
                            <div class="action-content">
                                <h6>Improve {{ dimension }}</h6>
                                <p>
                                    Current: Level {{ current_level }} → Target: Level {{ current_level + 1 }}
                                </p>
                                <div class="action-description">
                                    {% if dimension == 'Build and Deployment' %}
                                        {% if current_level == 1 %}
                                            Establish basic build and deployment processes with version control
                                        {% elif current_level == 2 %}
                                            Implement automated build pipelines and deployment scripts
                                        {% elif current_level == 3 %}
                                            Add security scanning and automated testing to CI/CD pipeline
                                        {% elif current_level == 4 %}
                                            Implement advanced security controls and continuous monitoring
                                        {% endif %}
                                    {% elif dimension == 'Culture and Organization' %}
                                        {% if current_level == 1 %}
                                            Establish security awareness and basic training programs
                                        {% elif current_level == 2 %}
                                            Create security policies and incident response procedures
                                        {% elif current_level == 3 %}
                                            Implement regular security training and culture assessment
                                        {% elif current_level == 4 %}
                                            Foster security-first culture with continuous improvement
                                        {% endif %}
                                    {% elif dimension == 'Implementation' %}
                                        {% if current_level == 1 %}
                                            Implement basic secure coding practices and code reviews
                                        {% elif current_level == 2 %}
                                            Establish secure development standards and guidelines
                                        {% elif current_level == 3 %}
                                            Add automated security testing and dependency scanning
                                        {% elif current_level == 4 %}
                                            Implement advanced threat modeling and security architecture
                                        {% endif %}
                                    {% elif dimension == 'Information Gathering' %}
                                        {% if current_level == 1 %}
                                            Establish basic threat intelligence and vulnerability tracking
                                        {% elif current_level == 2 %}
                                            Implement systematic security monitoring and logging
                                        {% elif current_level == 3 %}
                                            Add advanced threat detection and incident correlation
                                        {% elif current_level == 4 %}
                                            Implement predictive security analytics and threat hunting
                                        {% endif %}
                                    {% elif dimension == 'Test and Verification' %}
                                        {% if current_level == 1 %}
                                            Establish basic security testing and vulnerability scanning
                                        {% elif current_level == 2 %}
                                            Implement regular penetration testing and security assessments
                                        {% elif current_level == 3 %}
                                            Add automated security testing and continuous validation
                                        {% elif current_level == 4 %}
                                            Implement advanced testing methodologies and security verification
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="action-priority">
                                <span class="priority-badge priority-{{ 6 - current_level }}">
                                    {% if current_level == 1 %}Critical{% elif current_level == 2 %}High{% elif current_level == 3 %}Medium{% else %}Low{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export and Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">
                    <i class="bi bi-download me-2"></i>Export Results
                </h5>
                <button class="btn btn-outline-primary btn-lg rounded-pill px-4 me-3" onclick="exportToPDF()">
                    <i class="bi bi-file-pdf me-2"></i>Export to PDF
                </button>
                <button class="btn btn-outline-secondary btn-lg rounded-pill px-4 me-3" onclick="exportToExcel()">
                    <i class="bi bi-file-excel me-2"></i>Export to Excel
                </button>
                <button class="btn btn-outline-info btn-lg rounded-pill px-4" onclick="shareResults()">
                    <i class="bi bi-share me-2"></i>Share Results
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function exportToPDF() {
    // Implementation for PDF export
    alert('PDF export functionality will be implemented');
}

function exportToExcel() {
    // Implementation for Excel export
    alert('Excel export functionality will be implemented');
}

function shareResults() {
    // Implementation for sharing results
    alert('Share functionality will be implemented');
}

// Initialize tooltips and animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    const progressBars = document.querySelectorAll('.percentage-fill');
    progressBars.forEach(bar => {
        const percentage = bar.dataset.percentage;
        setTimeout(() => {
            bar.style.width = percentage + '%';
        }, 500);
    });
    
    // Animate maturity levels
    const maturityLevels = document.querySelectorAll('.maturity-level');
    maturityLevels.forEach((level, index) => {
        setTimeout(() => {
            level.style.transform = 'scale(1.1)';
            setTimeout(() => {
                level.style.transform = 'scale(1)';
            }, 300);
        }, index * 200);
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}